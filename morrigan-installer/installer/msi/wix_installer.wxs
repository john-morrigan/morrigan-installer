<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <!-- Product Definition -->
    <Product Id="PUT-PRODUCT-GUID-HERE" 
             Name="Morrigan" 
             Language="1033" 
             Version="1.0.0.0" 
             Manufacturer="Morrigan AI" 
             UpgradeCode="PUT-GUID-HERE">
        
        <!-- Package Information -->
        <Package InstallerVersion="500" 
                 Compressed="yes" 
                 InstallScope="perMachine" 
                 Description="Morrigan LLM Monitoring Client"
                 Comments="Advanced LLM activity monitoring and logging client"
                 Keywords="LLM,Monitoring,AI,Client" />

        <!-- Upgrade Logic -->
        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." 
                      Schedule="afterInstallInitialize" />

        <!-- Media Template -->
        <MediaTemplate EmbedCab="yes" />

        <!-- Installation UI -->
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
        <UIRef Id="WixUI_InstallDir" />
        <UIRef Id="WixUI_ErrorProgressText" />

        <!-- License Agreement -->
        <WixVariable Id="WixUILicenseRtf" Value="..\..\resources\license\LICENSE.rtf" />
        
        <!-- Custom Images -->
        <WixVariable Id="WixUIBannerBmp" Value="..\..\resources\images\banner.bmp" />
        <WixVariable Id="WixUIDialogBmp" Value="..\..\resources\images\dialog.bmp" />

        <!-- Main Feature -->
        <Feature Id="ProductFeature" Title="Morrigan Client" Level="1" 
                 Description="Core Morrigan monitoring application and components">
            <ComponentGroupRef Id="ProductComponents" />
            <ComponentGroupRef Id="ApplicationShortcuts" />
        </Feature>

        <!-- Optional Features -->
        <Feature Id="ServiceFeature" Title="Windows Service" Level="1000"
                 Description="Install Morrigan as a Windows service (automatic startup)">
            <ComponentGroupRef Id="ServiceComponents" />
        </Feature>

        <!-- Directory Structure -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder">
                <Directory Id="INSTALLFOLDER" Name="Morrigan">
                    <Directory Id="ConfigFolder" Name="config" />
                    <Directory Id="LogsFolder" Name="logs" />
                    <Directory Id="DataFolder" Name="data" />
                </Directory>
            </Directory>
            
            <!-- Start Menu -->
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="Morrigan" />
            </Directory>
            
            <!-- Desktop -->
            <Directory Id="DesktopFolder" Name="Desktop" />
            
            <!-- AppData for user configuration -->
            <Directory Id="AppDataFolder">
                <Directory Id="MorriganAppDataFolder" Name="Morrigan" />
            </Directory>
        </Directory>

        <!-- Main Application Components -->
        <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
            <!-- Main Executable -->
            <Component Id="MorriganExecutable" Guid="PUT-COMPONENT-MAIN-GUID">
                <File Id="MorriganExe" 
                      Source="path\to\your\morrigan.exe" 
                      KeyPath="yes" 
                      Checksum="yes">
                    <!-- File Association -->
                    <ProgId Id="Morrigan.Config" Description="Morrigan Configuration">
                        <Extension Id="morrigan" ContentType="application/json">
                            <Verb Id="open" Command="Open" Argument='"%%1"' />
                        </Extension>
                    </ProgId>
                </File>
                
                <!-- Registry entries for application -->
                <RegistryKey Root="HKLM" Key="SOFTWARE\Morrigan AI\Morrigan">
                    <RegistryValue Name="InstallPath" Type="string" Value="[INSTALLFOLDER]" />
                    <RegistryValue Name="Version" Type="string" Value="1.0.0.0" />
                    <RegistryValue Name="Manufacturer" Type="string" Value="Morrigan AI" />
                </RegistryKey>
                
                <!-- Firewall exception (if needed) -->
                <FirewallException Id="MorriganFirewall" 
                                   Name="Morrigan Client" 
                                   Scope="localSubnet" 
                                   IgnoreFailure="yes" />
            </Component>

            <!-- Configuration Files -->
            <Component Id="MorriganConfig" Guid="PUT-COMPONENT-CONFIG-GUID" Directory="ConfigFolder">
                <File Id="DefaultConfig" Source="..\..\templates\default_config.json" Name="config.json" />
                <File Id="EnvTemplate" Source="..\..\templates\.env.template" Name=".env.example" />
            </Component>

            <!-- Documentation -->
            <Component Id="MorriganDocs" Guid="PUT-COMPONENT-LICENSE-GUID">
                <File Id="ReadmeFile" Source="..\..\..\..\morrigan\README.md" />
                <File Id="LicenseFile" Source="..\..\resources\license\LICENSE.rtf" />
            </Component>

            <!-- Application Icon -->
            <Component Id="MorriganResources" Guid="PUT-COMPONENT-RESOURCES-GUID">
                <File Id="MorriganIcon" Source="..\..\resources\icons\morrigan.ico" />
            </Component>
        </ComponentGroup>

        <!-- Shortcuts -->
        <ComponentGroup Id="ApplicationShortcuts">
            <!-- Start Menu Shortcut -->
            <Component Id="ApplicationShortcut" Directory="ApplicationProgramsFolder" 
                       Guid="{12345678-1234-1234-1234-123456789012}">
                <Shortcut Id="ApplicationStartMenuShortcut"
                          Name="Morrigan Client"
                          Description="LLM Monitoring Client"
                          Target="[INSTALLFOLDER]morrigan.exe"
                          WorkingDirectory="INSTALLFOLDER"
                          Icon="MorriganIcon" />
                <RemoveFolder Id="CleanUpStartMenu" Directory="ApplicationProgramsFolder" On="uninstall" />
                <RegistryValue Root="HKCU" Key="Software\Morrigan AI\Morrigan" Name="StartMenuShortcut" 
                               Type="integer" Value="1" KeyPath="yes" />
            </Component>

            <!-- Desktop Shortcut (Optional) -->
            <Component Id="DesktopShortcut" Directory="DesktopFolder" 
                       Guid="{12345678-1234-1234-1234-123456789013}">
                <Condition>DESKTOP_SHORTCUT</Condition>
                <Shortcut Id="ApplicationDesktopShortcut"
                          Name="Morrigan Client"
                          Description="LLM Monitoring Client"
                          Target="[INSTALLFOLDER]morrigan.exe"
                          WorkingDirectory="INSTALLFOLDER"
                          Icon="MorriganIcon" />
                <RegistryValue Root="HKCU" Key="Software\Morrigan AI\Morrigan" Name="DesktopShortcut" 
                               Type="integer" Value="1" KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- Windows Service Components (Optional) -->
        <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">
            <Component Id="MorriganService" Guid="{12345678-1234-1234-1234-123456789014}">
                <File Id="ServiceInstaller" Source="..\..\templates\service_install.bat" />
                <File Id="ServiceUninstaller" Source="..\..\templates\service_uninstall.bat" />
                
                <!-- Service Installation -->
                <ServiceInstall Id="MorriganServiceInstall"
                                Type="ownProcess"
                                Vital="yes"
                                Name="MorriganService"
                                DisplayName="Morrigan LLM Monitor"
                                Description="Morrigan LLM activity monitoring service"
                                Start="auto"
                                Account="LocalSystem"
                                ErrorControl="ignore"
                                Interactive="no">
                    <ServiceDependency Id="Winmgmt" />
                </ServiceInstall>
                
                <!-- Service Control -->
                <ServiceControl Id="StartMorriganService" 
                                Start="install" 
                                Stop="both" 
                                Remove="uninstall" 
                                Name="MorriganService" 
                                Wait="yes" />
            </Component>
        </ComponentGroup>

        <!-- Installation Properties -->
        <Property Id="INSTALLFOLDER">
            <RegistrySearch Id="FindInstallLocation" Root="HKLM" Key="SOFTWARE\Morrigan AI\Morrigan" 
                            Name="InstallPath" Type="directory" />
        </Property>

        <!-- Custom Properties for UI -->
        <Property Id="DESKTOP_SHORTCUT" Value="1" />
        <Property Id="LAUNCH_APP_ON_EXIT" Value="1" />

        <!-- Custom Actions -->
        <CustomAction Id="LaunchApplication" 
                      FileKey="MorriganExe" 
                      ExeCommand="" 
                      Execute="immediate" 
                      Impersonate="yes" 
                      Return="asyncNoWait" />

        <!-- Installation Sequences -->
        <InstallExecuteSequence>
            <Custom Action="LaunchApplication" After="InstallFinalize">
                <![CDATA[NOT Installed AND LAUNCH_APP_ON_EXIT]]>
            </Custom>
        </InstallExecuteSequence>

        <!-- Icon Definition -->
        <Icon Id="MorriganIcon" SourceFile="..\..\resources\icons\morrigan.ico" />
        <Property Id="ARPPRODUCTICON" Value="MorriganIcon" />
        
        <!-- Add/Remove Programs Configuration -->
        <Property Id="ARPHELPLINK" Value="https://github.com/MorriganAI/morrigan" />
        <Property Id="ARPURLINFOABOUT" Value="https://github.com/MorriganAI/morrigan" />
        <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
        <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />
    </Product>
</Wix>